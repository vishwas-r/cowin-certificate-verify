{"ast":null,"code":"import _regeneratorRuntime from\"D:/My Works/Git/cowin-verify/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _objectSpread from\"D:/My Works/Git/cowin-verify/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/objectSpread2\";import _asyncToGenerator from\"D:/My Works/Git/cowin-verify/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _slicedToArray from\"D:/My Works/Git/cowin-verify/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import React,{useEffect,useState}from\"react\";import\"./index.css\";import CertificateValidImg from\"../../assets/img/certificate-valid.svg\";import CertificateInValidImg from\"../../assets/img/certificate-invalid.svg\";import NextArrowImg from\"../../assets/img/next-arrow.svg\";// import LearnProcessImg from \"../../assets/img/leanr_more_small.png\";\n// import FeedbackSmallImg from \"../../assets/img/feedback-small.png\";\n// import DownloadSmallImg from \"../../assets/img/download-certificate-small.png\";\nimport config from\"../../config\";import{pathOr}from\"ramda\";import{CustomButton}from\"../CustomButton\";import{CertificateDetailsPaths}from\"../../constants\";import{useDispatch}from\"react-redux\";import{addEventAction,EVENT_TYPES}from\"../../redux/reducers/events\";import{useHistory}from\"react-router-dom\";import axios from\"axios\";import{ordinal_suffix_of}from\"../../utils/utils\";import{Loader}from\"../Loader\";import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";var jsigs=require('jsonld-signatures');var _require=require('crypto-ld'),RSAKeyPair=_require.RSAKeyPair;var _require2=require('jsonld'),documentLoaders=_require2.documentLoaders;var documentLoader=documentLoaders.node;var _require3=require('security-context'),contexts=_require3.contexts;var credentialsv1=require('../../utils/credentials.json');var _require4=require('vaccination-context'),vaccinationContext=_require4.vaccinationContext,vaccinationContextV2=_require4.vaccinationContextV2;var customLoader=function customLoader(url){console.log(\"checking \"+url);var c={\"did:india\":config.certificatePublicKey,\"https://example.com/i/india\":config.certificatePublicKey,\"https://w3id.org/security/v1\":contexts.get(\"https://w3id.org/security/v1\"),'https://www.w3.org/2018/credentials#':credentialsv1,\"https://www.w3.org/2018/credentials/v1\":credentialsv1,\"https://cowin.gov.in/credentials/vaccination/v1\":vaccinationContext,\"https://cowin.gov.in/credentials/vaccination/v2\":vaccinationContextV2};var context=c[url];if(context===undefined){context=contexts[url];}if(context!==undefined){return{contextUrl:null,documentUrl:url,document:context};}if(url.startsWith(\"{\")){return JSON.parse(url);}console.log(\"Fallback url lookup for document :\"+url);return documentLoader()(url);};export var CertificateStatus=function CertificateStatus(_ref){var certificateData=_ref.certificateData,goBack=_ref.goBack;var _useState=useState(false),_useState2=_slicedToArray(_useState,2),isLoading=_useState2[0],setLoading=_useState2[1];var _useState3=useState(false),_useState4=_slicedToArray(_useState3,2),isValid=_useState4[0],setValid=_useState4[1];var _useState5=useState({}),_useState6=_slicedToArray(_useState5,2),data=_useState6[0],setData=_useState6[1];var history=useHistory();setTimeout(function(){try{axios.post(\"/divoc/api/v1/events/\",{\"date\":new Date().toISOString(),\"type\":\"verify\"}).catch(function(e){console.log(e);});}catch(e){console.log(e);}},100);var dispatch=useDispatch();useEffect(function(){setLoading(true);function verifyData(){return _verifyData.apply(this,arguments);}function _verifyData(){_verifyData=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){var signedJSON,publicKey,controller,key,AssertionProofPurpose,RsaSignature2018,result,revokedResponse;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.prev=0;signedJSON=JSON.parse(certificateData);publicKey={'@context':jsigs.SECURITY_CONTEXT_URL,id:'did:india',type:'RsaVerificationKey2018',controller:'https://cowin.gov.in/',publicKeyPem:config.certificatePublicKey};controller={'@context':jsigs.SECURITY_CONTEXT_URL,id:'https://cowin.gov.in/',publicKey:[publicKey],// this authorizes this key to be used for making assertions\nassertionMethod:[publicKey.id]};key=new RSAKeyPair(_objectSpread({},publicKey));AssertionProofPurpose=jsigs.purposes.AssertionProofPurpose;RsaSignature2018=jsigs.suites.RsaSignature2018;_context.next=9;return jsigs.verify(signedJSON,{suite:new RsaSignature2018({key:key}),purpose:new AssertionProofPurpose({controller:controller}),documentLoader:customLoader,compactProof:false});case 9:result=_context.sent;if(!result.verified){_context.next=21;break;}_context.next=13;return checkIfRevokedCertificate(signedJSON);case 13:revokedResponse=_context.sent;if(!(revokedResponse.response.status!==200)){_context.next=21;break;}console.log('Signature verified.');setValid(true);setData(signedJSON);dispatch(addEventAction({type:EVENT_TYPES.VALID_VERIFICATION,extra:signedJSON.credentialSubject}));setLoading(false);return _context.abrupt(\"return\");case 21:dispatch(addEventAction({type:EVENT_TYPES.INVALID_VERIFICATION,extra:signedJSON}));setValid(false);setLoading(false);_context.next=32;break;case 26:_context.prev=26;_context.t0=_context[\"catch\"](0);console.log('Invalid data',_context.t0);setValid(false);dispatch(addEventAction({type:EVENT_TYPES.INVALID_VERIFICATION,extra:certificateData}));setLoading(false);case 32:case\"end\":return _context.stop();}}},_callee,null,[[0,26]]);}));return _verifyData.apply(this,arguments);}setTimeout(function(){verifyData();},500);},[]);function checkIfRevokedCertificate(_x){return _checkIfRevokedCertificate.apply(this,arguments);}function _checkIfRevokedCertificate(){_checkIfRevokedCertificate=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(data){return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:return _context2.abrupt(\"return\",axios.post(\"/divoc/api/v1/certificate/revoked\",data).then(function(res){dispatch(addEventAction({type:EVENT_TYPES.REVOKED_CERTIFICATE,extra:certificateData}));return res;}).catch(function(e){console.log(e);return e;}));case 1:case\"end\":return _context2.stop();}}},_callee2);}));return _checkIfRevokedCertificate.apply(this,arguments);}function getCertificateStatusAsString(data){if(!data||!data[\"evidence\"]){return\"\";}var dose=data[\"evidence\"][0][\"dose\"];var totalDoses=data[\"evidence\"][0][\"totalDoses\"]||2;if(dose===totalDoses){return\"Final Certificate for COVID-19 Vaccination\";}else{return\"Provisional Certificate for COVID-19 Vaccination (\".concat(getDose(data),\" Dose)\");}}function getDose(data){if(!data||!data[\"evidence\"]){return\"\";}return ordinal_suffix_of(data[\"evidence\"][0][\"dose\"]);}return isLoading?/*#__PURE__*/_jsx(Loader,{}):/*#__PURE__*/_jsxs(\"div\",{className:\"certificate-status-wrapper\",children:[/*#__PURE__*/_jsx(\"img\",{src:isValid?CertificateValidImg:CertificateInValidImg,alt:\"\",className:\"certificate-status-image\"}),/*#__PURE__*/_jsx(\"h3\",{className:\"certificate-status\",children:isValid?\"Certificate Successfully Verified\":\"Certificate Invalid\"}),/*#__PURE__*/_jsx(\"br\",{}),isValid&&/*#__PURE__*/_jsx(\"h5\",{children:getCertificateStatusAsString(data)}),isValid&&/*#__PURE__*/_jsx(\"table\",{className:\"mt-3\",children:Object.keys(CertificateDetailsPaths).map(function(key,index){var context=CertificateDetailsPaths[key];var value=context.format(pathOr(\"NA\",context.path,data));var show=value!==\"NA\"||value===\"NA\"&&!context.optional;return show&&/*#__PURE__*/_jsxs(\"tr\",{style:{fontSize:\"smaller\",textAlign:\"left\"},children:[/*#__PURE__*/_jsx(\"td\",{className:\"pr-3\",children:key.replace(\"${dose}\",getDose(data))}),/*#__PURE__*/_jsx(\"td\",{className:\"font-weight-bolder value-col\",children:value})]},index);})}),/*#__PURE__*/_jsx(\"br\",{}),/*#__PURE__*/_jsx(CustomButton,{className:\"blue-btn m-3\",onClick:goBack,children:\"Verify Another Certificate\"})]});};export var SmallInfoCards=function SmallInfoCards(_ref2){var text=_ref2.text,img=_ref2.img,onClick=_ref2.onClick,backgroundColor=_ref2.backgroundColor;return/*#__PURE__*/_jsxs(\"div\",{className:\"small-info-card-wrapper mt-3 mb-3\",style:{backgroundColor:backgroundColor},children:[/*#__PURE__*/_jsx(\"div\",{className:\"w-50 \",children:/*#__PURE__*/_jsx(\"img\",{src:img,alt:\"\",className:\"small-card-img float-right\"})}),/*#__PURE__*/_jsxs(\"div\",{onClick:onClick,className:\"w-50 d-flex flex-column align-items-start justify-content-center font-weight-bold\",children:[/*#__PURE__*/_jsx(\"span\",{children:text}),/*#__PURE__*/_jsx(\"img\",{src:NextArrowImg,alt:\"\"})]})]});};","map":{"version":3,"sources":["D:/My Works/Git/cowin-verify/src/components/CertificateStatus/index.js"],"names":["React","useEffect","useState","config","pathOr","CustomButton","CertificateDetailsPaths","useDispatch","addEventAction","EVENT_TYPES","useHistory","axios","ordinal_suffix_of","Loader","jsigs","require","RSAKeyPair","documentLoaders","documentLoader","node","contexts","credentialsv1","vaccinationContext","vaccinationContextV2","customLoader","url","console","log","c","certificatePublicKey","get","context","undefined","contextUrl","documentUrl","document","startsWith","JSON","parse","CertificateStatus","certificateData","goBack","isLoading","setLoading","isValid","setValid","data","setData","history","setTimeout","post","Date","toISOString","catch","e","dispatch","verifyData","signedJSON","publicKey","SECURITY_CONTEXT_URL","id","type","controller","publicKeyPem","assertionMethod","key","AssertionProofPurpose","purposes","RsaSignature2018","suites","verify","suite","purpose","compactProof","result","verified","checkIfRevokedCertificate","revokedResponse","response","status","VALID_VERIFICATION","extra","credentialSubject","INVALID_VERIFICATION","then","res","REVOKED_CERTIFICATE","getCertificateStatusAsString","dose","totalDoses","getDose","CertificateValidImg","CertificateInValidImg","Object","keys","map","index","value","format","path","show","optional","fontSize","textAlign","replace","SmallInfoCards","text","img","onClick","backgroundColor","NextArrowImg"],"mappings":"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","sourcesContent":["import React, {useEffect, useState} from \"react\";\nimport \"./index.css\";\nimport CertificateValidImg from \"../../assets/img/certificate-valid.svg\";\nimport CertificateInValidImg from \"../../assets/img/certificate-invalid.svg\";\nimport NextArrowImg from \"../../assets/img/next-arrow.svg\";\n// import LearnProcessImg from \"../../assets/img/leanr_more_small.png\";\n// import FeedbackSmallImg from \"../../assets/img/feedback-small.png\";\n// import DownloadSmallImg from \"../../assets/img/download-certificate-small.png\";\nimport config from \"../../config\";\nimport {pathOr} from \"ramda\";\nimport {CustomButton} from \"../CustomButton\";\nimport {CertificateDetailsPaths} from \"../../constants\";\nimport {useDispatch} from \"react-redux\";\nimport {addEventAction, EVENT_TYPES} from \"../../redux/reducers/events\";\nimport {useHistory} from \"react-router-dom\";\nimport axios from \"axios\";\nimport {ordinal_suffix_of} from \"../../utils/utils\";\nimport {Loader} from \"../Loader\";\n\nconst jsigs = require('jsonld-signatures');\nconst {RSAKeyPair} = require('crypto-ld');\nconst {documentLoaders} = require('jsonld');\nconst {node: documentLoader} = documentLoaders;\nconst {contexts} = require('security-context');\nconst credentialsv1 = require('../../utils/credentials.json');\nconst {vaccinationContext, vaccinationContextV2} = require('vaccination-context');\n\nconst customLoader = url => {\n    console.log(\"checking \" + url);\n    const c = {\n        \"did:india\": config.certificatePublicKey,\n        \"https://example.com/i/india\": config.certificatePublicKey,\n        \"https://w3id.org/security/v1\": contexts.get(\"https://w3id.org/security/v1\"),\n        'https://www.w3.org/2018/credentials#': credentialsv1,\n        \"https://www.w3.org/2018/credentials/v1\": credentialsv1,\n        \"https://cowin.gov.in/credentials/vaccination/v1\": vaccinationContext,\n        \"https://cowin.gov.in/credentials/vaccination/v2\": vaccinationContextV2,\n    };\n    let context = c[url];\n    if (context === undefined) {\n        context = contexts[url];\n    }\n    if (context !== undefined) {\n        return {\n            contextUrl: null,\n            documentUrl: url,\n            document: context\n        };\n    }\n    if (url.startsWith(\"{\")) {\n        return JSON.parse(url);\n    }\n    console.log(\"Fallback url lookup for document :\" + url)\n    return documentLoader()(url);\n};\n\nexport const CertificateStatus = ({certificateData, goBack}) => {\n    const [isLoading, setLoading] = useState(false);\n    const [isValid, setValid] = useState(false);\n    const [data, setData] = useState({});\n    const history = useHistory();\n\n    setTimeout(()=>{\n        try {\n            axios\n              .post(\"/divoc/api/v1/events/\", {\"date\":new Date().toISOString(), \"type\":\"verify\"})\n              .catch((e) => {\n                console.log(e);\n            });\n        } catch (e) {\n            console.log(e);\n        }\n    }, 100)\n\n    const dispatch = useDispatch();\n    useEffect(() => {\n        setLoading(true);\n        async function verifyData() {\n            try {\n                const signedJSON = JSON.parse(certificateData);\n                const publicKey = {\n                    '@context': jsigs.SECURITY_CONTEXT_URL,\n                    id: 'did:india',\n                    type: 'RsaVerificationKey2018',\n                    controller: 'https://cowin.gov.in/',\n                    publicKeyPem: config.certificatePublicKey\n                };\n                const controller = {\n                    '@context': jsigs.SECURITY_CONTEXT_URL,\n                    id: 'https://cowin.gov.in/',\n                    publicKey: [publicKey],\n                    // this authorizes this key to be used for making assertions\n                    assertionMethod: [publicKey.id]\n                };\n                const key = new RSAKeyPair({...publicKey});\n                const {AssertionProofPurpose} = jsigs.purposes;\n                const {RsaSignature2018} = jsigs.suites;\n                const result = await jsigs.verify(signedJSON, {\n                    suite: new RsaSignature2018({key}),\n                    purpose: new AssertionProofPurpose({controller}),\n                    documentLoader: customLoader,\n                    compactProof: false\n                });\n                if (result.verified) {\n                    const revokedResponse = await checkIfRevokedCertificate(signedJSON)\n                    if (revokedResponse.response.status !== 200) {\n                        console.log('Signature verified.');\n                        setValid(true);\n                        setData(signedJSON);\n                        dispatch(addEventAction({\n                            type: EVENT_TYPES.VALID_VERIFICATION,\n                            extra: signedJSON.credentialSubject\n                        }));\n                        setLoading(false);\n                        return;\n                    }\n                }\n                dispatch(addEventAction({type: EVENT_TYPES.INVALID_VERIFICATION, extra: signedJSON}));\n                setValid(false);\n                setLoading(false);\n            } catch (e) {\n                console.log('Invalid data', e);\n                setValid(false);\n                dispatch(addEventAction({type: EVENT_TYPES.INVALID_VERIFICATION, extra: certificateData}));\n                setLoading(false);\n            }\n\n        }\n        setTimeout(() => {\n            verifyData()\n        }, 500)\n\n    }, []);\n\n    async function checkIfRevokedCertificate(data) {\n        return axios\n            .post(\"/divoc/api/v1/certificate/revoked\", data)\n            .then((res) => {\n                dispatch(addEventAction({type: EVENT_TYPES.REVOKED_CERTIFICATE, extra: certificateData}));\n                return res\n            }).catch((e) => {\n                console.log(e);\n                return e\n            });\n    }\n\n    function getCertificateStatusAsString(data) {\n        if (!data || !data[\"evidence\"]) {\n            return \"\"\n        }\n\n        const dose = data[\"evidence\"][0][\"dose\"]\n        const totalDoses = data[\"evidence\"][0][\"totalDoses\"] || 2\n\n        if (dose === totalDoses) {\n            return \"Final Certificate for COVID-19 Vaccination\"\n        } else {\n            return `Provisional Certificate for COVID-19 Vaccination (${getDose(data)} Dose)`\n        }\n    }\n\n    function getDose(data) {\n        if (!data || !data[\"evidence\"]) {\n            return \"\"\n        }\n        return ordinal_suffix_of(data[\"evidence\"][0][\"dose\"])\n    }\n\n    return (\n        isLoading ? <Loader/> : <div className=\"certificate-status-wrapper\">\n            <img src={isValid ? CertificateValidImg : CertificateInValidImg} alt={\"\"}\n                 className=\"certificate-status-image\"/>\n            <h3 className=\"certificate-status\">\n                {\n                    isValid ? \"Certificate Successfully Verified\" : \"Certificate Invalid\"\n                }\n            </h3>\n            <br/>\n            {\n                isValid && <h5>\n                    {\n                        getCertificateStatusAsString(data)\n                    }\n                </h5>\n            }\n            {\n                isValid && <table className=\"mt-3\">\n                    {\n                        Object.keys(CertificateDetailsPaths).map((key, index) => {\n                            const context = CertificateDetailsPaths[key];\n                            const value = context.format(pathOr(\"NA\", context.path, data));\n                            const show = value !== \"NA\" || (value === \"NA\" && !context.optional)\n                            return (\n                              show && <tr key={index} style={{fontSize:\"smaller\", textAlign: \"left\"}}>\n                                    <td className=\"pr-3\" >{key.replace(\"${dose}\", getDose(data))}</td>\n                                    <td className=\"font-weight-bolder value-col\">{value}</td>\n                                </tr>\n                            )\n                        })\n                    }\n\n                </table>\n            }\n            <br/>\n            <CustomButton className=\"blue-btn m-3\" onClick={goBack}>Verify Another Certificate</CustomButton>\n            {/*<SmallInfoCards text={\"Provide Feedback\"}*/}\n            {/*                onClick={() => {*/}\n            {/*                    history.push(\"/side-effects\")*/}\n            {/*                }}*/}\n            {/*                img={FeedbackSmallImg} backgroundColor={\"#FFFBF0\"}/>*/}\n            {/*<SmallInfoCards text={\"Learn about the Vaccination process\"} img={LearnProcessImg}*/}\n            {/*               onClick={() => {*/}\n            {/*                    history.push(\"/learn\")*/}\n            {/*                }}*/}\n            {/*                backgroundColor={\"#EFF5FD\"}/>*/}\n        </div>\n    )\n};\n\nexport const SmallInfoCards = ({text, img, onClick, backgroundColor}) => (\n    <div className=\"small-info-card-wrapper mt-3 mb-3\" style={{backgroundColor: backgroundColor}}>\n        <div className=\"w-50 \">\n            <img src={img} alt={\"\"} className=\"small-card-img float-right\"/>\n        </div>\n        <div onClick={onClick}\n             className=\"w-50 d-flex flex-column align-items-start justify-content-center font-weight-bold\">\n            <span>{text}</span>\n            <img src={NextArrowImg} alt={\"\"}/>\n        </div>\n    </div>\n);\n"]},"metadata":{},"sourceType":"module"}